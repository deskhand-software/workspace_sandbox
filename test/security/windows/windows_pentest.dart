@TestOn('windows')
import 'dart:io';
import 'package:test/test.dart';
import 'package:workspace_sandbox/workspace_sandbox.dart';

void main() {
  group('Windows Security Pentest', () {
    late Workspace ws;

    setUp(() {
      ws = Workspace.ephemeral(
        options: const WorkspaceOptions(allowNetwork: false),
      );
    });

    tearDown(() async {
      await ws.dispose();
    });

    test('Exploit 1: Registry Key Write Attack', () async {
      const target =
          r'HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run';
      final cmd =
          'reg add "$target" /v "MalwarePayload" /t REG_SZ /d "C:\\malware.exe" /f';

      final result = await ws.run(cmd);

      if (result.exitCode == 0) {
        fail('CRITICAL: Sandbox allowed writing to Registry Run key!');
      }
    });

    test('Exploit 2: System32 File Modification', () async {
      final target = r'C:\Windows\System32\evil.dll';
      final cmd = 'echo malicious_code > "$target"';

      final result = await ws.run(cmd);

      if (result.exitCode == 0) {
        final file = File(target);
        if (await file.exists()) {
          try {
            await file.delete();
          } catch (_) {}
          fail('CRITICAL: Wrote to System32 directory!');
        }
      }
    });

    test('Exploit 3: UAC Bypass Attempt', () async {
      // Usamos triple comilla para evitar l√≠os de escaping
      final cmd =
          r'''powershell -Command "Start-Process cmd -Verb RunAs -ArgumentList '/c echo ELEVATED'"''';

      final result = await ws.run(cmd);

      if (result.stdout.contains('ELEVATED')) {
        fail('CRITICAL: UAC bypass succeeded!');
      }
    });

    test('Exploit 4: Network Bypass via PowerShell', () async {
      final cmd =
          r'''powershell -Command "try { (New-Object System.Net.WebClient).DownloadString('http://google.com'); Write-Output 'SUCCESS' } catch { Write-Output 'BLOCKED' }"''';

      final result = await ws.run(cmd);

      if (result.stdout.contains('SUCCESS')) {
        fail('CRITICAL: PowerShell bypassed network isolation!');
      }
    });

    test('Exploit 5: Process Injection (Hollow Process)', () async {
      final cmd =
          r'''powershell -Command "if (Test-Path C:\Windows\System32\calc.exe) { Write-Output INJECTABLE }"''';

      final result = await ws.run(cmd);

      if (result.stdout.contains('INJECTABLE')) {
        print('INFO: Sandbox can see system binaries (expected)');
      }
    });

    test('Exploit 6: Path Traversal via UNC Path', () async {
      final cmd = r'dir \\localhost\C$\Windows';
      final result = await ws.run(cmd);

      if (result.exitCode == 0 && result.stdout.contains('System32')) {
        fail('CRITICAL: UNC path allowed access to host filesystem!');
      }
    });

    test('Exploit 7: Timeout Kill Verification', () async {
      final stopwatch = Stopwatch()..start();
      final result = await ws.run('ping -n 10 127.0.0.1',
          options: const WorkspaceOptions(timeout: Duration(seconds: 2)));
      stopwatch.stop();

      expect(result.isCancelled, isTrue,
          reason: 'Process should be killed by timeout');
      expect(stopwatch.elapsed.inSeconds, lessThan(6));
    });
  });
}
