@TestOn('mac-os')
import 'dart:io';
import 'package:test/test.dart';
import 'package:workspace_sandbox/workspace_sandbox.dart';

void main() {
  group('macOS Security Pentest', () {
    late Workspace ws;

    setUp(() {
      ws = Workspace.ephemeral(
        options: const WorkspaceOptions(allowNetwork: false),
      );
    });

    tearDown(() async {
      await ws.dispose();
    });

    test('Exploit 1: SIP Protected Path Write', () async {
      final target = '/usr/bin/hacked';
      final result = await ws.run('touch $target');

      if (result.exitCode == 0) {
        if (await File(target).exists()) {
          try {
            await File(target).delete();
          } catch (_) {}
          fail('CRITICAL: Wrote to SIP-protected /usr/bin!');
        }
      }
    });

    test('Exploit 2: Keychain Access Attack', () async {
      final result = await ws.run('security find-generic-password -ga "login"');
      if (result.stdout.contains('password:')) {
        fail('CRITICAL: Keychain access granted!');
      }
    });

    test('Exploit 3: LaunchAgent Persistence', () async {
      final result =
          await ws.run('touch ~/Library/LaunchAgents/com.malware.plist');
      if (result.exitCode == 0) {
        fail('CRITICAL: LaunchAgent loaded!');
      }
    });

    test('Exploit 4: Network Bypass', () async {
      final result =
          await ws.run('curl -I https://apple.com --connect-timeout 3');
      if (result.exitCode == 0) {
        fail('CRITICAL: Network isolation bypassed!');
      }
    });

    test('Exploit 5: Process Timeout Kill', () async {
      final stopwatch = Stopwatch()..start();
      final result = await ws.run('sleep 10',
          options: const WorkspaceOptions(timeout: Duration(seconds: 2)));
      stopwatch.stop();

      expect(result.isCancelled, isTrue);
      expect(stopwatch.elapsed.inSeconds, lessThan(5));
    });
  });
}
